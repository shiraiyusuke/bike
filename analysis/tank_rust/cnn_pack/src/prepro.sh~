#!/usr/bin/env sh

##########################################
#画像データから軽量DBを作成する
#画像の正規化を行うための平均値の計算を行う
##########################################

##############使用方法#####################
#1:下記の各変数値を設定
#
#2:./prepro.sh option
#
#[option]
# convert_train_all: 学習データのDB化および画像の平均値ファイルの作成
# conert_test: 検証用データのDB化
# all: 上記をすべて実効
#
###########################################


#caffe/build/toolsへのパス
CAFFE_TOOLS=/usr/local/image_processing/caffe_20150401/build/tools
TOOLS=/usr/local/image_processing/work/tools


#ワーキングディレクトリ
WORK_DIR=/data2/pon/data

#学習に用いる画像のリスト
#<画像パス　ラベル>の形式
#ラベルは0から始まる通し番号に限る
TRAIN_PATH=$WORK_DIR/lst4s_train_all_addold_neg3_cropsou.txt

#検証に用いる画像のリスト
#<画像パス　ラベル>の形式
#ラベルは0から始まる通し番号に限る
TEST_PATH=$WORK_DIR/test_crop_sou_balanced.txt

#出力DB名
TRAIN_DB=train_souall_addold_neg3_cropsou_40_40_lmdb
TEST_DB=test_cropsou_bal_24_24_lmdb


#画像の平均値ファイルの出力先
#バイナリ形式
MEAN_PROTO_PATH=$WORK_DIR/mean_train_souall_addold_neg3_cropsou.proto
#numpy配列形式
MEAN_NPY_PATH=$WORK_DIR/mean_train_souall_addold_neg3_cropsou.npy

#グレイスケールにするか
GRAY_F=1

#リサイズ後の画像サイズ
HEIGHT=24
WIDTH=24

convert_train_all() {
    rm -rf $WORK_DIR/$TRAIN_DB
    if [ $GRAY_F = 0 ] ; then
        echo "======= not gray ======="
        $CAFFE_TOOLS/convert_imageset.bin -resize_height $HEIGHT -resize_width $WIDTH \
            -shuffle / $TRAIN_PATH $WORK_DIR/$TRAIN_DB
    else
        echo "======= gray ======="
        $CAFFE_TOOLS/convert_imageset.bin -resize_height $HEIGHT -resize_width $WIDTH \
            -gray -shuffle / $TRAIN_PATH $WORK_DIR/$TRAIN_DB
    fi
    echo "======= compute mean ======="
    $CAFFE_TOOLS/compute_image_mean.bin $WORK_DIR/$TRAIN_DB $MEAN_PROTO_PATH #lmdb
    echo "======= mean2npy ======="
    python $TOOLS/mean2npy.py $MEAN_PROTO_PATH $MEAN_NPY_PATH
}

convert_test() {
    rm -rf $WORK_DIR/$TEST_DB
    if [ $GRAY_F = 0 ] ; then
        echo "======= not gray ======="
        $CAFFE_TOOLS/convert_imageset.bin -resize_height $HEIGHT -resize_width $WIDTH \
            -shuffle / $TEST_PATH $WORK_DIR/$TEST_DB
    else
        echo "======= gray ======="
        $CAFFE_TOOLS/convert_imageset.bin -resize_height $HEIGHT -resize_width $WIDTH \
            -gray -shuffle / $TEST_PATH $WORK_DIR/$TEST_DB
    fi
}






case "$1" in
    "convert_train_all" )
        convert_train_all ;;
    "convert_test" )
        convert_test ;;
    "all" )
	echo ${TRAIN_PATH}
        convert_train_all
        convert_test
        break ;;
esac

#convert_train_all


